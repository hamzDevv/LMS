// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

// database mysql
datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// atribut user
model User {
  id            String    @id @default(uuid())
  name          String
  email         String    @unique
  password      String?
  avatar        String?
  role          Role      @default(USER)
  provider      Provider  @default(CREDENTIALS)
  emailVerified DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  courses        Course[]
  articles       Article[]
  enrollments    Enrollment[]
  lessonProgress LessonProgress[]
  subscriptions  Subscription[]
  payments       Payment[]

  @@map("users")
}

// atribut kategori untuk course
model Category {
  id          String   @id @default(uuid())
  name        String
  slug        String   @unique
  description String?
  icon        String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  courses  Course[]
  articles Article[]

  @@map("categories")
}

// atribut course
model Course {
  id            String     @id @default(uuid())
  title         String
  slug          String     @unique
  description   String     @db.Text
  thumbnail     String?
  level         Level      @default(PEMULA)
  type          CourseType @default(GRATIS)
  price         Decimal    @default(0) @db.Decimal(10, 2)
  totalVideos   Int        @default(0)
  totalDuration Int        @default(0)
  isPublished   Boolean    @default(false)
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  categoryId String
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  authorId String
  author   User   @relation(fields: [authorId], references: [id], onDelete: Cascade)

  lessons        Lesson[]
  enrollments    Enrollment[]
  roadmapCourses RoadmapCourse[]
  payments       Payment[]

  @@index([categoryId])
  @@index([authorId])
  @@map("courses")
}

// course video
model Lesson {
  id        String   @id @default(uuid())
  title     String
  slug      String
  content   String   @db.Text
  videoUrl  String?
  duration  Int?
  order     Int
  isPreview Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  courseId String
  course   Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  lessonProgress LessonProgress[]

  @@index([courseId])
  @@map("lessons")
}

// course article
model Article {
  id          String   @id @default(uuid())
  title       String
  slug        String   @unique
  content     String   @db.Text
  excerpt     String?  @db.Text
  thumbnail   String?
  isPremium   Boolean  @default(false)
  views       Int      @default(0)
  isPublished Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  categoryId String
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  authorId String
  author   User   @relation(fields: [authorId], references: [id], onDelete: Cascade)

  articleTags ArticleTag[]

  @@index([categoryId])
  @@index([authorId])
  @@map("articles")
}

// atribut tag
model Tag {
  id        String   @id @default(uuid())
  name      String   @unique
  slug      String   @unique
  createdAt DateTime @default(now())

  articleTags ArticleTag[]

  @@map("tags")
}

// article tag
model ArticleTag {
  articleId String
  article   Article @relation(fields: [articleId], references: [id], onDelete: Cascade)

  tagId String
  tag   Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([articleId, tagId])
  @@map("article_tags")
}

// atrbut progres user
model Enrollment {
  id          String    @id @default(uuid())
  progress    Int       @default(0)
  completedAt DateTime?
  createdAt   DateTime  @default(now())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  courseId String
  course   Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([userId])
  @@index([courseId])
  @@map("enrollments")
}

// atribut lesson progres user
model LessonProgress {
  id          String    @id @default(uuid())
  isCompleted Boolean   @default(false)
  completedAt DateTime?
  createdAt   DateTime  @default(now())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  lessonId String
  lesson   Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([userId, lessonId])
  @@index([userId])
  @@index([lessonId])
  @@map("lesson_progress")
}

// masa waktu bulanan, tahunan atau selamanya
model Subscription {
  id        String             @id @default(uuid())
  plan      SubscriptionPlan
  status    SubscriptionStatus @default(ACTIVE)
  startDate DateTime
  endDate   DateTime
  price     Decimal            @db.Decimal(10, 2)
  createdAt DateTime           @default(now())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  payments Payment[]

  @@index([userId])
  @@map("subscriptions")
}

// pembayaran
model Payment {
  id            String        @id @default(uuid())
  amount        Decimal       @db.Decimal(10, 2)
  status        PaymentStatus @default(PENDING)
  paymentMethod String
  transactionId String?
  createdAt     DateTime      @default(now())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  subscriptionId String?
  subscription   Subscription? @relation(fields: [subscriptionId], references: [id], onDelete: SetNull)

  courseId String?
  course   Course? @relation(fields: [courseId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@map("payments")
}

// roadmap untuk developer
model Roadmap {
  id          String   @id @default(uuid())
  title       String
  slug        String   @unique
  description String   @db.Text
  thumbnail   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  roadmapCourses RoadmapCourse[]

  @@map("roadmaps")
}

// roadmap course
model RoadmapCourse {
  order Int

  roadmapId String
  roadmap   Roadmap @relation(fields: [roadmapId], references: [id], onDelete: Cascade)

  courseId String
  course   Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@id([roadmapId, courseId])
  @@map("roadmap_courses")
}

enum Role {
  USER
  ADMIN
}

enum Provider {
  CREDENTIALS
  GOOGLE
  GITHUB
}

enum Level {
  PEMULA
  MENENGAH
  MAHIR
}

enum CourseType {
  GRATIS
  PREMIUM
}

enum SubscriptionPlan {
  MONTHLY
  ANNUAL
  FOREVER
}

enum SubscriptionStatus {
  ACTIVE
  EXPIRED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
}
